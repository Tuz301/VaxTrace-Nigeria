version: '3.8'

services:
  # PostgreSQL with PostGIS for geospatial data and persistent storage
  postgres:
    image: postgis/postgis:16-3.4-alpine
    container_name: vaxtrace-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-vaxtrace_admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-vaxtrace_nigeria}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_NG.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - vaxtrace_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vaxtrace_admin} -d ${POSTGRES_DB:-vaxtrace_nigeria}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      postgres
      -c shared_preload_libraries='pg_stat_statements,pgcrypto'
      -c pgcrypto.require='true'
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=2621kB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis for caching with TLS support
  redis:
    image: redis:7.2-alpine
    container_name: vaxtrace-redis
    restart: unless-stopped
    command: >
      sh -c "if [ -f /etc/redis/tls/redis.crt ]; then redis-server --requirepass ${REDIS_PASSWORD} --tls-port 6380 --port 6379 --tls-cert-file /etc/redis/tls/redis.crt --tls-key-file /etc/redis/tls/redis.key --tls-ca-cert-file /etc/redis/tls/ca.crt --tls-auth-clients no --maxmemory 512mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000 --appendonly yes --appendfsync everysec; else redis-server --requirepass ${REDIS_PASSWORD} --port 6379 --maxmemory 512mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000 --appendonly yes --appendfsync everysec; fi"
    ports:
      - "${REDIS_PORT:-6379}:6379"
      - "${REDIS_TLS_PORT:-6380}:6380"
    volumes:
      - redis_data:/data
      - ./backend/config/redis/tls:/etc/redis/tls:ro
    networks:
      - vaxtrace_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # pgAdmin for database management (optional, for development)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: vaxtrace-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@vaxtrace.ng}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - vaxtrace_network
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - development

  # Redis Commander for Redis management (optional, for development)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: vaxtrace-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD}
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    networks:
      - vaxtrace_network
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - development

  # ============================================================================
  # APPLICATION SERVICES
  # ============================================================================

  # NestJS Backend API Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        NODE_ENV: production
    image: vaxtrace-backend:latest
    container_name: vaxtrace-backend
    restart: unless-stopped
    environment:
      # Application
      NODE_ENV: production
      PORT: 8000
      HOSTNAME: "0.0.0.0"
      TZ: Africa/Lagos
      
      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: ${POSTGRES_USER:-vaxtrace_admin}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_NAME: ${POSTGRES_DB:-vaxtrace_nigeria}
      DATABASE_SSL: "false"
      DATABASE_POOL_MIN: 2
      DATABASE_POOL_MAX: 20
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_TLS: "false"
      REDIS_DB: 0
      
      # JWT & Security
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-1h}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-7d}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      
      # OpenLMIS Integration
      OPENLMIS_BASE_URL: ${OPENLMIS_BASE_URL}
      OPENLMIS_CLIENT_ID: ${OPENLMIS_CLIENT_ID}
      OPENLMIS_CLIENT_SECRET: ${OPENLMIS_CLIENT_SECRET}
      OPENLMIS_REFRESH_TOKEN: ${OPENLMIS_REFRESH_TOKEN}
      
      # Monitoring & Observability
      SENTRY_DSN: ${SENTRY_DSN}
      SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-production}
      POSTHOG_KEY: ${POSTHOG_KEY}
      POSTHOG_HOST: ${POSTHOG_HOST:-https://app.posthog.com}
      
      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN:-https://vaxtrace.gov.ng}
      
      # Rate Limiting
      RATE_LIMIT_TTL: 60
      RATE_LIMIT_MAX: 100
      
      # WebSocket
      WS_PORT: 8001
    ports:
      - "${BACKEND_PORT:-8000}:8000"
      - "${WS_PORT:-8001}:8001"
    volumes:
      - backend_logs:/app/logs
      - ./backend/config/tls:/app/config/tls:ro
    networks:
      - vaxtrace_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # GxCP Resource Limits (GBB Cloud m1.large: 4 vCPU, 8GB RAM)
    deploy:
      resources:
        limits:
          cpus: '3.5'
          memory: 7G
        reservations:
          cpus: '1.0'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # Next.js Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
        NEXT_PUBLIC_MAPBOX_TOKEN: ${NEXT_PUBLIC_MAPBOX_TOKEN}
        NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN}
        NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY}
        NODE_ENV: production
    image: vaxtrace-frontend:latest
    container_name: vaxtrace-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: "0.0.0.0"
      TZ: Africa/Lagos
      
      # API Configuration
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:8001}
      
      # Map Configuration
      NEXT_PUBLIC_MAPBOX_TOKEN: ${NEXT_PUBLIC_MAPBOX_TOKEN}
      NEXT_PUBLIC_DEFAULT_LAT: ${NEXT_PUBLIC_DEFAULT_LAT:-9.0820}
      NEXT_PUBLIC_DEFAULT_LNG: ${NEXT_PUBLIC_DEFAULT_LNG:-8.6753}
      NEXT_PUBLIC_DEFAULT_ZOOM: ${NEXT_PUBLIC_DEFAULT_ZOOM:-6}
      
      # Feature Flags
      NEXT_PUBLIC_ENABLE_BIOMETRIC: ${NEXT_PUBLIC_ENABLE_BIOMETRIC:-true}
      NEXT_PUBLIC_ENABLE_OFFLINE: ${NEXT_PUBLIC_ENABLE_OFFLINE:-true}
      NEXT_PUBLIC_ENABLE_PWA: ${NEXT_PUBLIC_ENABLE_PWA:-true}
      
      # Analytics & Monitoring
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN}
      NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY}
      NEXT_PUBLIC_POSTHOG_HOST: ${NEXT_PUBLIC_POSTHOG_HOST:-https://app.posthog.com}
      
      # OpenLMIS
      NEXT_PUBLIC_OPENLMIS_URL: ${NEXT_PUBLIC_OPENLMIS_URL}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    networks:
      - vaxtrace_network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # GxCP Resource Limits (GBB Cloud m1.medium: 2 vCPU, 4GB RAM)
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 3.5G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # Nginx Reverse Proxy Service
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: vaxtrace-nginx:latest
    container_name: vaxtrace-nginx
    restart: unless-stopped
    environment:
      TZ: Africa/Lagos
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./backend/config/tls:/etc/nginx/tls:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    networks:
      - vaxtrace_network
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # GxCP Resource Limits (GBB Cloud m1.small: 1 vCPU, 2GB RAM)
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 1.5G
        reservations:
          cpus: '0.25'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

networks:
  vaxtrace_network:
    driver: bridge
    name: vaxtrace_network
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  # Infrastructure volumes
  postgres_data:
    name: vaxtrace_postgres_data
    driver: local
  redis_data:
    name: vaxtrace_redis_data
    driver: local
  pgadmin_data:
    name: vaxtrace_pgadmin_data
    driver: local
  
  # Application volumes
  backend_logs:
    name: vaxtrace_backend_logs
    driver: local
  nginx_cache:
    name: vaxtrace_nginx_cache
    driver: local
  nginx_logs:
    name: vaxtrace_nginx_logs
    driver: local
